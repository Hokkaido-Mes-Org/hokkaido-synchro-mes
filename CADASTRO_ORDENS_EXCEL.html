<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Ordens de Produ√ß√£o - Synchro MES</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        header {
            background: linear-gradient(135deg, #0077C2 0%, #005A9A 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        header h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        header p {
            font-size: 0.95em;
            opacity: 0.9;
        }

        .toolbar {
            background: #f9f9f9;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
        }

        .toolbar button {
            background: #0077C2;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .toolbar button:hover {
            background: #005A9A;
        }

        .toolbar button.secondary {
            background: #6c757d;
        }

        .toolbar button.secondary:hover {
            background: #5a6268;
        }

        .content {
            padding: 30px 20px;
        }

        .info-box {
            background: #e6f2ff;
            border-left: 4px solid #0077C2;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        thead {
            background: linear-gradient(135deg, #0077C2 0%, #005A9A 100%);
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }

        th {
            padding: 15px;
            text-align: left;
            border-bottom: 2px solid #0077C2;
        }

        td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        tbody tr:hover {
            background: #f9f9f9;
            transition: background 0.2s;
        }

        tbody tr:nth-child(even) {
            background: #f5f5f5;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.95em;
            font-family: inherit;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #0077C2;
            box-shadow: 0 0 5px rgba(0, 119, 194, 0.3);
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .btn-add-row {
            background: #28a745;
            margin-top: 10px;
        }

        .btn-add-row:hover {
            background: #218838;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .status-label {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-ativo {
            background: #d4edda;
            color: #155724;
        }

        .status-pausado {
            background: #fff3cd;
            color: #856404;
        }

        .status-concluido {
            background: #cce5ff;
            color: #004085;
        }

        footer {
            background: #f9f9f9;
            border-top: 1px solid #e0e0e0;
            padding: 20px;
            text-align: center;
            color: #666;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }

        .modal-header h2 {
            color: #0077C2;
            font-size: 1.5em;
        }

        .close-modal {
            font-size: 2em;
            font-weight: bold;
            color: #aaa;
            cursor: pointer;
            transition: color 0.3s;
            background: none;
            border: none;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-modal:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
            border-top: 2px solid #e0e0e0;
            padding-top: 15px;
        }

        .btn-cancel {
            background: #6c757d;
        }

        .btn-cancel:hover {
            background: #5a6268;
        }

        .btn-save {
            background: #0077C2;
        }

        .btn-save:hover {
            background: #005A9A;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }

        .alert.show {
            display: block;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .total-box {
            background: #f0f8ff;
            border: 2px solid #0077C2;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
            font-weight: 600;
            color: #0077C2;
            text-align: center;
            font-size: 1.1em;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5em;
            }

            .toolbar {
                flex-direction: column;
            }

            .toolbar button {
                width: 100%;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px;
            }

            .modal-content {
                padding: 20px;
            }
        }

        .help-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .required {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìã Cadastro de Ordens de Produ√ß√£o</h1>
            <p>Synchro MES v2.0 - Hokkaido Plastics</p>
        </header>

        <div class="toolbar">
            <button onclick="abrirModalImportarExcel()">
                üì§ Importar do Excel
            </button>
            <button onclick="abrirModalNovaOrdem()">
                ‚ûï Nova Ordem
            </button>
            <button class="secondary" onclick="exportarExcel()">
                üì• Exportar Excel
            </button>
            <button class="secondary" onclick="limparTabela()">
                üóëÔ∏è Limpar Tudo
            </button>
            <button class="secondary" onclick="imprimirTabela()">
                üñ®Ô∏è Imprimir
            </button>
        </div>

        <div class="content">
            <div class="info-box">
                <strong>‚ÑπÔ∏è Instru√ß√µes</strong>: Use "üì§ Importar do Excel" para carregar ordens de uma planilha Excel automaticamente, ou clique em "‚ûï Nova Ordem" para adicionar manualmente. Use "üì• Exportar Excel" para salvar os dados em um arquivo Excel que pode ser reabre.
            </div>

            <div id="alertBox" class="alert"></div>

            <div class="table-wrapper">
                <table id="tabelaOrdens">
                    <thead>
                        <tr>
                            <th style="width: 5%">ID</th>
                            <th style="width: 10%">C√≥digo OP</th>
                            <th style="width: 12%">Produto</th>
                            <th style="width: 10%">M√°quina</th>
                            <th style="width: 10%">Mat√©ria-Prima</th>
                            <th style="width: 8%">Lote</th>
                            <th style="width: 8%">Ciclo (s)</th>
                            <th style="width: 8%">Cavidades</th>
                            <th style="width: 8%">Peso Pe√ßa (g)</th>
                            <th style="width: 8%">Embalagem</th>
                            <th style="width: 8%">Data</th>
                            <th style="width: 10%">Status</th>
                            <th style="width: 8%">A√ß√£o</th>
                        </tr>
                    </thead>
                    <tbody id="corpoTabela">
                    </tbody>
                </table>
            </div>

            <div class="total-box" id="totalBox" style="display: none;">
                Total de Ordens: <span id="totalOrdens">0</span>
            </div>
        </div>
    </div>

    <!-- Modal para Importar Excel -->
    <div id="modalImportarExcel" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì§ Importar Ordens do Excel</h2>
                <button class="close-modal" onclick="fecharModalImportarExcel()">&times;</button>
            </div>

            <div class="form-group">
                <label for="inputExcel">Selecione o arquivo Excel (.xlsx) <span class="required">*</span></label>
                <input type="file" id="inputExcel" accept=".xlsx,.xls" style="padding: 20px; border: 2px dashed #0077C2; background: #f0f8ff; cursor: pointer;">
                <div class="help-text">Clique para selecionar um arquivo Excel com as ordens a importar</div>
            </div>

            <div id="previewImportacao" style="display: none; margin-top: 20px;">
                <h3>Pr√©via das Ordens a Importar:</h3>
                <div style="max-height: 300px; overflow-y: auto; margin: 10px 0;">
                    <table style="width: 100%; font-size: 0.85em;">
                        <thead>
                            <tr style="background: #f0f8ff;">
                                <th>C√≥digo OP</th>
                                <th>Produto</th>
                                <th>M√°quina</th>
                                <th>Lote</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="previewTabela"></tbody>
                    </table>
                </div>
            </div>

            <div id="mensagemImportacao" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>

            <div class="modal-footer">
                <button type="button" class="toolbar button btn-cancel" onclick="fecharModalImportarExcel()">
                    ‚ùå Cancelar
                </button>
                <button type="button" class="toolbar button btn-save" id="btnImportar" onclick="executarImportacao()" style="display: none;">
                    ‚úÖ Importar Ordens
                </button>
            </div>
        </div>
    </div>

    <!-- Modal para Nova Ordem -->
    <div id="modalNovaOrdem" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚ûï Nova Ordem de Produ√ß√£o</h2>
                <button class="close-modal" onclick="fecharModalNovaOrdem()">&times;</button>
            </div>

            <form id="formNovaOrdem">
                <div class="form-group">
                    <label for="codigoOP">C√≥digo da OP <span class="required">*</span></label>
                    <input type="text" id="codigoOP" placeholder="Ex: OP-2025-001" required>
                    <div class="help-text">Digite um c√≥digo √∫nico para identificar esta ordem</div>
                </div>

                <div class="form-group">
                    <label for="nomeProduto">Nome do Produto <span class="required">*</span></label>
                    <input type="text" id="nomeProduto" placeholder="Ex: Tampa Pl√°stica 50mm" required>
                </div>

                <div class="form-group">
                    <label for="codigoProduto">C√≥digo do Produto <span class="required">*</span></label>
                    <input type="text" id="codigoProduto" placeholder="Ex: 12345" required>
                </div>

                <div class="form-group">
                    <label for="maquina">M√°quina <span class="required">*</span></label>
                    <select id="maquina" required>
                        <option value="">Selecione uma m√°quina...</option>
                        <option value="H-01">H-01</option>
                        <option value="H-05">H-05</option>
                        <option value="H-06">H-06</option>
                        <option value="H-11">H-11</option>
                        <option value="H-12">H-12</option>
                        <option value="H-14">H-14</option>
                        <option value="H-16">H-16</option>
                        <option value="H-17">H-17</option>
                        <option value="H-18">H-18</option>
                        <option value="H-19">H-19</option>
                        <option value="H-20">H-20</option>
                        <option value="H-22">H-22</option>
                        <option value="H-27">H-27</option>
                        <option value="H-31">H-31</option>
                        <option value="H-32">H-32</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="materiaPrima">Mat√©ria-Prima <span class="required">*</span></label>
                    <input type="text" id="materiaPrima" placeholder="Ex: Polipropileno Branco" required>
                </div>

                <div class="form-group">
                    <label for="lote">Tamanho do Lote (pe√ßas) <span class="required">*</span></label>
                    <input type="number" id="lote" placeholder="Ex: 5000" min="1" required>
                </div>

                <div class="form-group">
                    <label for="ciclo">Ciclo Padr√£o (segundos) <span class="required">*</span></label>
                    <input type="number" id="ciclo" placeholder="Ex: 45" min="1" step="0.1" required>
                    <div class="help-text">Tempo padr√£o para uma batida na m√°quina</div>
                </div>

                <div class="form-group">
                    <label for="cavidades">Cavidades <span class="required">*</span></label>
                    <input type="number" id="cavidades" placeholder="Ex: 4" min="1" required>
                    <div class="help-text">Quantidade de pe√ßas por ciclo</div>
                </div>

                <div class="form-group">
                    <label for="pesoPeca">Peso da Pe√ßa (gramas) <span class="required">*</span></label>
                    <input type="number" id="pesoPeca" placeholder="Ex: 25.5" min="0.1" step="0.01" required>
                </div>

                <div class="form-group">
                    <label for="embalagem">Quantidade por Embalagem (pe√ßas) <span class="required">*</span></label>
                    <input type="number" id="embalagem" placeholder="Ex: 100" min="1" required>
                    <div class="help-text">Pe√ßas por saco/caixa/embalagem</div>
                </div>

                <div class="form-group">
                    <label for="dataOrdem">Data da Ordem <span class="required">*</span></label>
                    <input type="date" id="dataOrdem" required>
                </div>

                <div class="form-group">
                    <label for="statusOrdem">Status <span class="required">*</span></label>
                    <select id="statusOrdem" required>
                        <option value="">Selecione o status...</option>
                        <option value="Planejado">Planejado</option>
                        <option value="Ativo">Ativo</option>
                        <option value="Pausado">Pausado</option>
                        <option value="Conclu√≠do">Conclu√≠do</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes</label>
                    <textarea id="observacoes" placeholder="Notas adicionais sobre esta ordem..."></textarea>
                </div>

                <div class="modal-footer">
                    <button type="button" class="toolbar button btn-cancel" onclick="fecharModalNovaOrdem()">
                        ‚ùå Cancelar
                    </button>
                    <button type="submit" class="toolbar button btn-save">
                        ‚úÖ Salvar Ordem
                    </button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <p><strong>Vers√£o</strong>: 1.0 | <strong>Sistema</strong>: Synchro MES v2.0 | <strong>√öltima Atualiza√ß√£o</strong>: Novembro/2025</p>
        <p>¬© Hokkaido Plastics - Todos os direitos reservados</p>
    </footer>

    <script>
        let ordens = [];
        let proximoID = 1;
        let ordensParaImportar = [];

        // Inicializar data de hoje no formul√°rio
        document.getElementById('dataOrdem').valueAsDate = new Date();

        // Event listeners
        document.getElementById('formNovaOrdem').addEventListener('submit', function(e) {
            e.preventDefault();
            adicionarOrdem();
        });

        document.getElementById('inputExcel').addEventListener('change', function(e) {
            lerArquivoExcel(e);
        });

        // Carregar dados do localStorage ao iniciar
        window.addEventListener('load', function() {
            carregarDados();
            atualizarTabela();
        });

        // === FUN√á√ïES DE IMPORTA√á√ÉO EXCEL ===

        function abrirModalImportarExcel() {
            document.getElementById('modalImportarExcel').classList.add('active');
            document.getElementById('inputExcel').value = '';
            document.getElementById('previewImportacao').style.display = 'none';
            document.getElementById('btnImportar').style.display = 'none';
            document.getElementById('mensagemImportacao').style.display = 'none';
            ordensParaImportar = [];
        }

        function fecharModalImportarExcel() {
            document.getElementById('modalImportarExcel').classList.remove('active');
            document.getElementById('inputExcel').value = '';
            document.getElementById('previewImportacao').style.display = 'none';
            document.getElementById('btnImportar').style.display = 'none';
            ordensParaImportar = [];
        }

        function lerArquivoExcel(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convertendo para JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet);
                    
                    if (jsonData.length === 0) {
                        mostrarAlerta('‚ö†Ô∏è O arquivo n√£o cont√©m dados!', 'warning');
                        return;
                    }

                    // Validar e processar dados
                    ordensParaImportar = validarDadosImportacao(jsonData);
                    
                    if (ordensParaImportar.length === 0) {
                        mostrarAlerta('‚ùå Nenhuma ordem v√°lida foi encontrada no arquivo!', 'error');
                        return;
                    }

                    // Mostrar preview
                    mostrarPreviewImportacao(ordensParaImportar);
                    
                } catch (error) {
                    mostrarAlerta('‚ùå Erro ao ler arquivo Excel: ' + error.message, 'error');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function validarDadosImportacao(dados) {
            const ordensValidas = [];

            dados.forEach((row, index) => {
                try {
                    // Mapeamento flex√≠vel de colunas (considera diferentes nomes)
                    const ordem = {
                        id: proximoID++,
                        codigoOP: row['C√≥digo OP'] || row['codigoOP'] || row['Codigo OP'] || row['codigo_op'] || '',
                        nomeProduto: row['Produto'] || row['Nome do Produto'] || row['nomeProduto'] || row['nome_produto'] || '',
                        codigoProduto: row['C√≥digo Produto'] || row['C√≥digo do Produto'] || row['codigoProduto'] || row['codigo_produto'] || '',
                        maquina: row['M√°quina'] || row['Maquina'] || row['maquina'] || '',
                        materiaPrima: row['Mat√©ria-Prima'] || row['Materia-Prima'] || row['MP'] || row['materiaPrima'] || '',
                        lote: String(row['Lote'] || row['Lote (pe√ßas)'] || row['lote'] || '0').replace(/[^\d]/g, ''),
                        ciclo: String(row['Ciclo'] || row['Ciclo (s)'] || row['ciclo'] || '0').replace(',', '.'),
                        cavidades: String(row['Cavidades'] || row['cavidades'] || '1').replace(/[^\d]/g, ''),
                        pesoPeca: String(row['Peso Pe√ßa'] || row['Peso Pe√ßa (g)'] || row['Peso da Pe√ßa'] || row['pesoPeca'] || '0').replace(',', '.'),
                        embalagem: String(row['Embalagem'] || row['Quantidade por Embalagem'] || row['embalagem'] || '100').replace(/[^\d]/g, ''),
                        data: formatarData(row['Data'] || row['data'] || new Date().toISOString().split('T')[0]),
                        status: row['Status'] || row['status'] || 'Planejado',
                        observacoes: row['Observa√ß√µes'] || row['Observacoes'] || row['observacoes'] || ''
                    };

                    // Validar campos obrigat√≥rios
                    if (!ordem.codigoOP || !ordem.nomeProduto || !ordem.maquina || !ordem.lote) {
                        console.warn(`Linha ${index + 1}: Dados incompletos, ignorando`);
                        return;
                    }

                    // Validar n√∫meros
                    if (isNaN(ordem.lote) || ordem.lote <= 0) {
                        console.warn(`Linha ${index + 1}: Lote inv√°lido`);
                        return;
                    }

                    ordensValidas.push(ordem);
                } catch (error) {
                    console.warn(`Erro ao processar linha ${index + 1}:`, error);
                }
            });

            return ordensValidas;
        }

        function formatarData(data) {
            if (!data) return new Date().toISOString().split('T')[0];
            
            // Se for um n√∫mero (Excel date)
            if (typeof data === 'number') {
                const excelDate = new Date((data - 25569) * 86400 * 1000);
                return excelDate.toISOString().split('T')[0];
            }
            
            // Se for string
            if (typeof data === 'string') {
                const dataParsed = new Date(data);
                if (!isNaN(dataParsed)) {
                    return dataParsed.toISOString().split('T')[0];
                }
            }
            
            return new Date().toISOString().split('T')[0];
        }

        function mostrarPreviewImportacao(ordensValidas) {
            const previewTabela = document.getElementById('previewTabela');
            previewTabela.innerHTML = '';

            ordensValidas.forEach(ordem => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${ordem.codigoOP}</strong></td>
                    <td>${ordem.nomeProduto}</td>
                    <td>${ordem.maquina}</td>
                    <td>${ordem.lote}</td>
                    <td><span class="status-label status-${ordem.status.toLowerCase().replace('√°', 'a')}">${ordem.status}</span></td>
                `;
                previewTabela.appendChild(row);
            });

            const mensagem = document.getElementById('mensagemImportacao');
            mensagem.textContent = `‚úÖ ${ordensValidas.length} ordem(s) pronta(s) para importar`;
            mensagem.className = 'alert show alert-success';
            mensagem.style.display = 'block';

            document.getElementById('previewImportacao').style.display = 'block';
            document.getElementById('btnImportar').style.display = 'block';
        }

        function executarImportacao() {
            if (ordensParaImportar.length === 0) {
                mostrarAlerta('‚ùå Nenhuma ordem para importar!', 'error');
                return;
            }

            // Adicionar todas as ordens
            ordensParaImportar.forEach(ordem => {
                ordens.push(ordem);
            });

            salvarDados();
            atualizarTabela();
            fecharModalImportarExcel();
            mostrarAlerta(`‚úÖ ${ordensParaImportar.length} ordem(s) importada(s) com sucesso!`, 'success');
            ordensParaImportar = [];
        }

        // === FUN√á√ïES ORIGINAIS ===

        function abrirModalNovaOrdem() {
            document.getElementById('modalNovaOrdem').classList.add('active');
            document.getElementById('dataOrdem').valueAsDate = new Date();
        }

        function fecharModalNovaOrdem() {
            document.getElementById('modalNovaOrdem').classList.remove('active');
            document.getElementById('formNovaOrdem').reset();
            document.getElementById('dataOrdem').valueAsDate = new Date();
        }

        function adicionarOrdem() {
            const ordem = {
                id: proximoID++,
                codigoOP: document.getElementById('codigoOP').value,
                nomeProduto: document.getElementById('nomeProduto').value,
                codigoProduto: document.getElementById('codigoProduto').value,
                maquina: document.getElementById('maquina').value,
                materiaPrima: document.getElementById('materiaPrima').value,
                lote: document.getElementById('lote').value,
                ciclo: document.getElementById('ciclo').value,
                cavidades: document.getElementById('cavidades').value,
                pesoPeca: document.getElementById('pesoPeca').value,
                embalagem: document.getElementById('embalagem').value,
                data: document.getElementById('dataOrdem').value,
                status: document.getElementById('statusOrdem').value,
                observacoes: document.getElementById('observacoes').value
            };

            ordens.push(ordem);
            salvarDados();
            atualizarTabela();
            fecharModalNovaOrdem();
            mostrarAlerta('‚úÖ Ordem adicionada com sucesso!', 'success');
        }

        function atualizarTabela() {
            const tbody = document.getElementById('corpoTabela');
            tbody.innerHTML = '';

            ordens.forEach(ordem => {
                const statusClass = `status-${ordem.status.toLowerCase().replace('√°', 'a')}`;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${ordem.id}</td>
                    <td><strong>${ordem.codigoOP}</strong></td>
                    <td>${ordem.nomeProduto}</td>
                    <td>${ordem.maquina}</td>
                    <td>${ordem.materiaPrima}</td>
                    <td>${parseInt(ordem.lote).toLocaleString('pt-BR')}</td>
                    <td>${parseFloat(ordem.ciclo).toFixed(1)}</td>
                    <td>${ordem.cavidades}</td>
                    <td>${parseFloat(ordem.pesoPeca).toFixed(2)}</td>
                    <td>${ordem.embalagem}</td>
                    <td>${new Date(ordem.data).toLocaleDateString('pt-BR')}</td>
                    <td><span class="status-label ${statusClass}">${ordem.status}</span></td>
                    <td>
                        <button class="btn-delete" onclick="deletarOrdem(${ordem.id})">
                            üóëÔ∏è Deletar
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            // Atualizar total
            const totalBox = document.getElementById('totalBox');
            const totalOrdens = document.getElementById('totalOrdens');
            if (ordens.length > 0) {
                totalBox.style.display = 'block';
                totalOrdens.textContent = ordens.length;
            } else {
                totalBox.style.display = 'none';
            }
        }

        function deletarOrdem(id) {
            if (confirm('Tem certeza que deseja deletar esta ordem?')) {
                ordens = ordens.filter(o => o.id !== id);
                salvarDados();
                atualizarTabela();
                mostrarAlerta('‚úÖ Ordem deletada com sucesso!', 'success');
            }
        }

        function salvarDados() {
            localStorage.setItem('ordensProducao', JSON.stringify(ordens));
            localStorage.setItem('proximoID', proximoID);
        }

        function carregarDados() {
            const dados = localStorage.getItem('ordensProducao');
            const id = localStorage.getItem('proximoID');
            if (dados) {
                ordens = JSON.parse(dados);
                proximoID = parseInt(id) || 1;
            }
        }

        function exportarExcel() {
            if (ordens.length === 0) {
                mostrarAlerta('‚ö†Ô∏è Nenhuma ordem para exportar!', 'warning');
                return;
            }

            const ws = XLSX.utils.json_to_sheet(ordens.map(o => ({
                'ID': o.id,
                'C√≥digo OP': o.codigoOP,
                'Produto': o.nomeProduto,
                'C√≥digo Produto': o.codigoProduto,
                'M√°quina': o.maquina,
                'Mat√©ria-Prima': o.materiaPrima,
                'Lote (pe√ßas)': o.lote,
                'Ciclo (s)': o.ciclo,
                'Cavidades': o.cavidades,
                'Peso Pe√ßa (g)': o.pesoPeca,
                'Embalagem': o.embalagem,
                'Data': new Date(o.data).toLocaleDateString('pt-BR'),
                'Status': o.status,
                'Observa√ß√µes': o.observacoes
            })));

            // Formatar colunas
            const colWidths = [5, 12, 20, 12, 10, 15, 10, 10, 10, 12, 10, 12, 12, 20];
            ws['!cols'] = colWidths.map(w => ({ wch: w }));

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Ordens');
            
            const dataAtual = new Date().toLocaleDateString('pt-BR').replace(/\//g, '-');
            XLSX.writeFile(wb, `Ordens_Producao_${dataAtual}.xlsx`);
            
            mostrarAlerta('‚úÖ Arquivo Excel exportado com sucesso!', 'success');
        }

        function imprimirTabela() {
            window.print();
        }

        function limparTabela() {
            if (confirm('Tem certeza que deseja limpar TODAS as ordens? Essa a√ß√£o n√£o pode ser desfeita!')) {
                ordens = [];
                proximoID = 1;
                salvarDados();
                atualizarTabela();
                mostrarAlerta('‚úÖ Todas as ordens foram removidas!', 'success');
            }
        }

        function mostrarAlerta(mensagem, tipo) {
            const alertBox = document.getElementById('alertBox');
            alertBox.textContent = mensagem;
            alertBox.className = `alert show alert-${tipo}`;
            
            setTimeout(() => {
                alertBox.classList.remove('show');
            }, 3000);
        }

        // Fechar modal ao clicar fora
        window.addEventListener('click', function(e) {
            const modalImportar = document.getElementById('modalImportarExcel');
            const modalNovaOrdem = document.getElementById('modalNovaOrdem');
            
            if (e.target === modalImportar) {
                fecharModalImportarExcel();
            }
            if (e.target === modalNovaOrdem) {
                fecharModalNovaOrdem();
            }
        });

        // Impedir fechar com Escape por enquanto (ou remover essa linha)
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                fecharModalNovaOrdem();
                fecharModalImportarExcel();
            }
        });
    </script>
</body>
</html>
