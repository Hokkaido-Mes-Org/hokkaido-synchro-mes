# ============================================================================
# HokkaidoMES â€” Deploy AutomÃ¡tico para Firebase Hosting
# ============================================================================
# Dispara em:
#   - Push para 'main'     â†’ Deploy de PRODUÃ‡ÃƒO (hokkaido-synchro.web.app)
#   - Push para 'staging'  â†’ Deploy de PREVIEW  (canal "staging")
#   - Pull Request p/ main â†’ Deploy de PREVIEW  (canal "pr-{number}")
#
# PrÃ©-requisitos:
#   1.Secret FIREBASE_SERVICE_ACCOUNT_HOKKAIDO_SYNCHRO configurado no repo
#      (Console Firebase â†’ Settings â†’ Service Accounts â†’ Generate new private key)
#   2. firebase.json e .firebaserc commitados no repositÃ³rio
# ============================================================================

name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 1: Deploy de PRODUÃ‡ÃƒO (somente push em main)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://hokkaido-synchro.web.app
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Deploy para Firebase Hosting (ProduÃ§Ã£o)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_HOKKAIDO_SYNCHRO }}'
          channelId: live
          projectId: hokkaido-synchro

      - name: Resumo do deploy
        run: |
          echo "## âœ… Deploy de ProduÃ§Ã£o" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://hokkaido-synchro.web.app" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: main" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Data**: $(date -u '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 2: Deploy de STAGING (push em staging)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-staging:
    if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
    runs-on: ubuntu-latest
    environment:
      name: staging
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Deploy para Firebase Hosting (Staging)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_HOKKAIDO_SYNCHRO }}'
          channelId: staging
          projectId: hokkaido-synchro
          expires: 7d

      - name: Resumo do deploy
        run: |
          echo "## ðŸ§ª Deploy de Staging" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Canal**: staging (expira em 7 dias)" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: staging" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # JOB 3: Preview em Pull Requests
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-preview:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Deploy Preview (PR)
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_HOKKAIDO_SYNCHRO }}'
          projectId: hokkaido-synchro
          expires: 3d
